---
layout: post
title: "使用csv做游戏数据配置表"
date: 2013-12-14 21:08
comments: true
categories: flash webgame
---
游戏中会用到很多数据表, slg游戏会用到二三十个, arpg可能会用到上百个, 这些配置表全部加一起说不定会有十几兆的大小, 而大部分的这些数据都是需要客户端在一开始就要读取的. 毕竟所有这些固定的数据是不会从服务端在通讯的时候发给你的, 那样对服务端的压力就太大了, 它只会告诉你简单的一些数据结构, 比如你的背包中有几个装备, 装备的服务端唯一标识符id是多少, 装备的配置表中的id是多少, 这样你就可以通过这个配置id然后从游戏初始加载数据中读取所有的信息: 装备的使用等级, 职业要求, 属性加成等等. 
###配置数据
用csv来做数据非常简单, 很多公司会自己开发内部工具来做数据, 自己研发的工具会更加适合自己的项目需要进行定制, 不过对于一般的游戏Excel已经提供了足够的功能了: 函数, 文件关联数据等等, 策划们可以随心的按照自己的需求进行演算和模拟, 然后把导出的数据一并另存为csv格式就可以供程序使用了. 

###csv的读取
csv的格式超级简单, 就是因为简单才又很烦它的过于简单设计导致使用的时候没那么简单, 不过只要我们解析方法写得好也就没什么问题. 下面说下我遇到的几个问题和解决的办法:

####1 读取. 

csv保存时是ANSI码, 如果你直接按照utf-8格式来读取的话里面的数据会乱码, 当然你也可以一个个文件另存为utf-8来保存, 然后这么读取就没问题了, 但是恶心人的是这样Excel就不认了, 它只认ANSI码保存的csv文件, 它打开一个保存了utf-8格式的csv也会是乱码, 不管怎么做都会有一方会是乱码, 所以我们还是安生点用原生的, 然后读取的时候使用"gb2312"格式读取就可以了, 不可以直接使用"ansi"读取, 这样在mac系统下会乱码.

####2 换行符. 

csv的每条数据是用换行来分隔的, 恶心的是在pc下导出的csv分隔符是\r\n, 但是在mac下导出的是\n, 我的方法是分别判断, 不可以直接都按照\r\n来做判断, 当然你确定你只用pc的Excel导出也可以, 但是世事难料谁知道呢. 分别判断完了后如果都有就把\r给彻底删了, 然后都用\n分隔.

####3 特殊符号. 

csv的每一条作为数据, 每一个单元格的值在导出的csv中都是用英文的逗号来分隔的, 这也就导致了如果你的某个单元格中使用了英文的逗号(不仅仅是逗号, html结构等都是如此), 导出的csv会自动给这个单元格数据的两端加上双引号以作区别, 如果数据中本来就有双引号呢? 双引号外头还会再套一层双引号的, 恶心的是即便你照顾到了双引号, 而不是单纯的按照逗号分隔数据读取你得到的数据依然会多出一堆的双引号出来(试试一条数据加上html文本, 里面加上双引号再看看其他数据是不是外头都套上了三层双引号了呢), 解决的办法就是一次性查找所有的成对双引号替换为一个单引号, 替换完成后把剩下的双引号全部删除.

####4 解析的速度. 

在这个air工具中速度其实不重要, 毕竟它只是一个内部工具负责打包数据用的而已, 关键是游戏中的数据. ByteArray的读取数据还是很快的, 目前的几十个数据表下来上十兆的文件一般解析也就只有三四百毫秒, 如果对这个速度还是不满意的话, 可以分割文件打包.


###在flash中使用csv

感谢苍天, flash有AMF3, 这么牛的文件格式居然得不到很多人的青睐, 当然你可能觉得它太小众更愿意选择google的protocol. 写一个工具(使用air)把csv文件进行读取和打包成Object然后保存成一个ByteArray文件, 这样在使用的时候直接readObject就可以拿来用了, 既压缩了数据也节省了读取文本文件转换为object的时间, 更牛的是有了amf3, 你还可以为这个工具写插件, 指定文件使用特定的解码类, 这样在项目中使用这些解码类你还直接节省了从Object对象转换为对象的手动操作. 比如Equip.csv, 写一个EquipVo类专门解析这个文件的数据, 然后air中使用EquipVo对Object的equip.csv每条数据进行包装, 直接save到byteArray中就可以了. 具体参考registerClassAlias这个api.

###更牛的是

研发中的游戏配置这块就可以实现工具化了, 更强大的话你可以给这个工具加上数据验证, 导出字段分类(有的客户端专用, 有的服务端专用), 自动刷新指定位置的csv文件, 发布的文件可以写加密插件定制数据格式和加密, 甚至可以捆绑svn在打包前先从版本库中拉取最新的csv配置文件等等.